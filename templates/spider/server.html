{% extends "base.html" %}
{% load static %}
{% block style%}
<!--        toastr消息通知-->
<link rel="stylesheet" href='{% static "css/toastr.min.css"%}'>
<script src='{% static "/jquery-3.2.1.min.js"%}'></script>
<script src='{% static "js/toastr.min.js" %}'></script>
<!--模态框去除表格的边框-->
<style>
    .row-fluid .span12 {
        width: 100%;
        margin-left: 0;
    }
    .table td {
    border:none;
    border-redius:3px;
    }



</style>
{% endblock %}


{% block info %}

<div class="span12">
        <div class="page-header">
            <h4>
                <button type="button" class="btn btn-info btn-sm" id="create" style="border: none;border-radius:3px;">创建主机</button>
                <small> 主机[1]默认为通用爬虫部署位</small>
                <form action="{% url 'spider:server'%}" method="get" style="float:right">
                    <input class="el-button--text" placeholder="主机名" name="hostname" style="height: 25px">
                    <button type="submit" id= "search" class="el-btn btn-danger" style="border-radius: 5px;height: 30px">搜索</button>
                </form>
            </h4>

        </div>
</div>
<table class="table table-striped table-hover">
<!--  显示及创建scrapyd服务器的列表-->
    <thead>
    <tr>
        <th>编号</th>
        <th>状态</th>
        <th>名称</th>
        <th>IP地址</th>
        <th>端口号</th>
        <th>认证</th>
        <th>操作</th>

    </tr>
    </thead>
    <tbody>
    {% for s in page %}
        <tr>
            <td class="ID">{{ s.id }}</td>
            <td class="status" _id="{{ forloop.counter0}}"><button type="button" style="border:none;display:none;"></button></td>
            <td class="name" _id="{{ forloop.counter0}}">{{ s.name }}</td>
            <td class="ip" _id="{{ forloop.counter0}}">{{ s.ip }}</td>
            <td class="port" _id="{{ forloop.counter0}}">{{s.port}}</td>
            {% if s.auth%}
            <td class="check" _id="{{ forloop.counter0}}">认证</td>
            {% else %}
            <td class="check" _id="{{ forloop.counter0}}">未认证</td>
            {% endif %}
            <td>
                <button type="button" class="btn-warning btn-sm" value="{{ s.id }}" onclick="scheduler(this)" style="border: none;border-radius:3px">项目</button>
                <button type="button" class="btn-info btn-sm" onclick="edit(this)" value="{{ s.id }}" style="border: none;border-radius:3px">配置</button>
                <button type="button" class="btn-danger btn-sm" onclick="del(this)" value="{{ s.id }}" style="border: none;border-radius:3px">删除</button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block script %}
 var toastr;
 toastr.options = {
    closeButton: true,//显示关闭按钮
    debug: false,
    progressBar: true,//显示进度条
    positionClass: "toast-top-center",//位置
    onclick: null,//点击消息框自定义事件
    showDuration: "300",//显示动作时间
    hideDuration: "1000",//隐藏动作时间
    timeOut: "2000",//显示时间,0为永久显示
    extendedTimeOut: "1000",//鼠标移动过后显示显示时间
    showEasing: "swing",
    hideEasing: "linear",
    showMethod: "fadeIn",//显示方式
    hideMethod: "fadeOut"//隐藏方式
 };


<!--   获取主机状态并更新任务-->
function status(){
    project=[]
    $('.ID').each(function(){
            project.push($(this).text())
        })
    console.log(project)
    if(project.length>0){
        $.get("/spider/client_status/",{"data":JSON.stringify(project)},function(result){
<!--            console.log(result.status)-->
<!--            console.log(project[i])-->
            if(result.status==200){
                results = result.results
                for(var i=0;i<results.length;i++){
                    if(results[i]==200){
                        $(".status[_id="+i+"] button").attr({"style":" display:block;border: none;","class":"btn-success btn-sm"})
                        $(".status[_id="+i+"] button").html("正常")
                    }else{
                        $(".status[_id="+i+"] button").attr({"style":" display:block;border: none;","class":"btn-warning btn-sm"})
                        $(".status[_id="+i+"] button").html("错误")
                    }
                }

            }
        })

    }else{
        toastr.warning("参数为空！");
    }
}

status();

$(document).ready(function(){
<!--创建主机-->
    $("#create_client").click(function(){
        ID = $("form table input[name='ID']").val()
        name = $("form table input[name='name']").val()
        ip = $("form table input[name='host']").val()
        port = $("form table input[name='port']").val()
<!--帐号密码-->
        auth = $("#account div.account-a.active").length
<!--启用主机节点监控-->
        enable = $(".inlineCheckbox:checked").val()
        client_enable = enable?1:2
        if(auth!=0){
            $("#account div.account-a>input[name='username']").empty()
            $("#account div.account-a>input[name='password']").empty()
            username = $("#account div.account-a>input[name='username']").val()
            password = $("#account div.account-a>input[name='password']").val()
        }else{
            username = ""
            password = ""
        }
        auth = auth?1:0
        console.log(username)
        console.log({"ID":ID,"name":name,"ip":ip,"port":port,"auth":auth,"username":username,"password":password,"client_enable":client_enable})
        $.post("/spider/client_create/",{"ID":ID,"name":name,"ip":ip,"port":port,"auth":auth,"username":username,"password":password,"client_enable":client_enable},function(result){
            if(result.status==200){
                toastr.success("创建成功！")
                setTimeout(() => {
                  reload();
                }, 3000);
            }else if(result.status==300){
                toastr.success("更新成功！")
<!--创建及更新成功后三秒刷新页面-->
                setTimeout(() => {
                  reload();
                }, 3000);
            }else{
                  toastr.error("创建失败！"+result.msg);
            }
        })

    })

});
<!--弹出创建主机设置窗口-->
    $("#create").click(function(){
        $('#myModal').modal('show');
    })
<!--编辑主机信息-->
function edit(key){
        $('#myModal').modal('show');
        info = $(key).val()
        console.log(info)
<!--        info = info.split(":")-->
        node = '<tr><td>ID:</td><td><input type="text" name="ID" required></td></tr><tr><td>名称:</td><td><input type="text" name="name" required></td></tr><tr><td>主机:</td><td><input type="text" name="host" required></td></tr><tr><td>端口:</td><td><input type="text" name="port" required></td></tr><tr><td colspan="2"><label class="checkbox inline"><input type="checkbox" class="inlineCheckbox" value="1">启用节点监控</label></td></tr>'
        $("form table").html(node)

        $.post("/spider/server.html",{"client_id":info},function(result){
            console.log(result)
            if(result.status==200){

                $("form table input[name='ID']").val(result.id)
                $("form table input[name='name']").val(result.name)
                $("form table input[name='host']").val(result.ip)
                $("form table input[name='port']").val(result.port)
                $("form table input[name='port']").val(result.port)
                if(result.client_enable!=2){
                    $(".inlineCheckbox").prop('checked', true);
                }
<!--                console.log(result.auth)-->
                if(result.auth!=0){
                    $(".account-a").addClass("active")

                    $("#account-b span").addClass("active")
                    console.log(result.username)
                    $("#account div.account-a>input[name='username']").val(result.username)
                    $("#account div.account-a>input[name='password']").val(result.password)
                }else{
                    $("#account-b span").removeClass("active")
                    $(".account-a").removeClass("active")
                    $("#account div.account-a>input[name='username']").val(result.username)
                    $("#account div.account-a>input[name='password']").val(result.username)

                }
            }
        })
    }
<!--删除主机信息-->
function del(key){
    id = $(key).val()
    $.get("/spider/client_del/"+id+"/",function(result){
        if(result.status==200){
                toastr.success("删除成功！")
                reload();
        }else{
              toastr.error("删除失败！"+result.msg);
        }
    })
}
<!--获取主机对应的项目-->
function viewpro(e){
    pid = $(e).val()
    console.log(pid)

    $.get("/spider/project/"+pid+"/",function(result){
        if(result.status==200){
            $('#myModal').modal('show');
            results = result.data
            console.log(results)
            tds=[]

            for(var i=0;i<results.length;i++){
                console.log(results[i].name)
                tds.push("<tr><td>"+(i+1)+"</td>"+"<td>"+results[i].name+"</td>"+"</tr>")
                $.get("/spider/spiders/"+pid+"/"+results[i].name+"/",function(res){
<!--                    console.log(res)-->
                    trs_list=[]
                    for(var k=0;k<res.length;k++){
<!--                        console.log(res[k].name)-->
<!--                        console.log(tds[i])-->
                        td_string = "<tr>"+"<td>"+res[k].name+"</td>"+"<td>"+'<label><input type="checkbox" value='+tds[k]+":"+res[k].name+' name="subbox" style="margin: -6px 6px 6px -5px">'+'</label>'+'</td>'+"</tr>"
<!--                        console.log(td_string)-->
                        trs_list.push(td_string)
                    }
                    $("table.table tr:gt(0)").html(trs_list.join())
                })
                for(k=0;k<tds.length;k++){
                    node = '<table class="table"><tr><th>编号</th><th>项目</th><th>名称</th><th>操作</th></tr>'+tds+'</table>'
                }
            }


            $("form table").html(node)
            header = '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">项目运行</h4>'
            $("div.modal-header").html(header)
            footer = '<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button><button type="button" class="btn btn-danger" id="crawl">运行</button>'
            $("div.modal-footer").html(footer)
            toastr.success("获取成功！")
        }else{
              toastr.error("获取失败！"+result.msg);
        }
    })
}
<!--刷新页面-->
function reload(){
    location.reload();
}
<!--跳转到调度页面-->
function scheduler(e){
    client_id = $(e).val()
    location.href='/spider/scheduler.html?client_id='+client_id
}
{% endblock %}


{% block footer %}
 <!--模态框设置定时任务-->
<div class="modal fade hide" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">主机设置</h4>
        </div>
        <div class="modal-body">
            <form method="post">
                <table class="table">
                    <tr>
                        <td>名称:</td>
                        <td><input type="text" name="name" required></td>
                    </tr>
                    <tr>
                        <td>主机:</td>
                        <td><input type="text" name="host" required></td>
                    </tr>
                    <tr>
                        <td>端口:</td>
                        <td><input type="text" name="port" required></td>
                    </tr>
                    <tr>
                        <td colspan="2"><label class="checkbox inline">
                              <input type="checkbox" class="inlineCheckbox" value="1">启用节点监控
                            </label>
                        </td>
                        <td></td>
                    </tr>

                </table>
            </form>
            <!--显示帐号密码输入框按钮样式-->
            <style>
                #account span{
                display:inline-block;
                width:100px;
                }
                .account-a{
                display:none;
                }
                .account-a.active{
                display:block;
                }
                #account-b{
                    width: 40px;
                    height: 20px;
                    border: 1px solid #d3d2d2;
                    border-radius: 20px;
                }
                #account-b span{
                 display:inline-block;
                 width:20px;
                 height:20px;
                 border-radius:50%;
                 background-color: #e74b4b;
                 float:left;
                }
                #account-b span.active{
                background-color: #8bc34a;
                float:right;
                }
            </style>

            <div id="account">
                <div id="account-b"><span></span></div>
                <div class="account-a"><span>帐号:</span><input type="text" name="username" value=""></div>
                <div class="account-a"><span>密码:</span><input type="text" name="password" value=""></div>
            </div>
        </div>
            <!--显示帐号密码输入框js-->
          <script>
                $("#account-b").click(function(){
                    $(".account-a").toggleClass("active")
                    $("#account-b span").toggleClass("active")
                })
          </script>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            <button type="button" class="btn btn-danger" id="create_client">创建/更新</button>
        </div>
    </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
{% endblock  %}
